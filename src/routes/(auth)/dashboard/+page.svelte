<script lang="ts">
	import { faker } from '@faker-js/faker';
	import { mdiChevronRight } from '@mdi/js';
	import { isHttpError, type SubmitFunction } from '@sveltejs/kit';

	import { getGames } from '$lib/api/games/get-games.remote';
	import { getRandomTagline } from '$lib/api/taglines/get-random-tagline.remote';
	import Icon from '$lib/components/icon/Icon.svelte';
	import { capitalizeAllWords } from '$lib/helpers';
	import { addToast } from '$lib/stores';
	import { addGame } from '$lib/api/games/add-game.remote';
	import { addGameSchema } from '$lib/schemas/add-game-schema';
	import type { RemoteFormEnhanceCallback } from '$lib/types/utils/enhance-callback';

	let dialogElement = $state<HTMLDialogElement>();
	let newGameTitle = $state<string>();
	let isSubmitting = $state(false);
	let getGamesResponse = getGames();

	const handleAddNewGameClick = () => {
		newGameTitle = capitalizeAllWords(`${faker.word.adjective()} ${faker.word.noun()}`);
		dialogElement?.showModal();
	};

	const handleCloseModalClick = () => {
		dialogElement?.close();
	};

	const handleAddNewGameSubmit: RemoteFormEnhanceCallback = async ({ submit }) => {
		try {
			isSubmitting = true;

			await submit();

			addToast('Game added', 'info');

			dialogElement?.close();
		} catch (error) {
			if (isHttpError(error)) {
				addToast(error.body.message, 'error');
			}
		} finally {
			isSubmitting = false;
		}
	};

	const getDateString = (date: string): string => new Date(date).toDateString();
</script>

<svelte:head>
	<title>Hand & Foot - Dashboard</title>

	<meta name="description" content="User dashboard for all of their games" />
</svelte:head>

<header aria-label="Current games">
	<h2>Your Games</h2>
	<button type="button" onclick={handleAddNewGameClick}>Add New Game</button>
</header>

<div>
	{#if getGamesResponse.error}
		<p>Something went wrong</p>
	{:else if getGamesResponse.loading}
		<p>Loading...</p>
	{:else}
		<ul>
			{#each getGamesResponse.current as game (game.id)}
				<li>
					<p>{game.title}</p>
					<p>
						<time datetime={getDateString(game.last_played_at)}
							>{getDateString(game.last_played_at)}</time
						>
					</p>
					<a
						href={`/dashboard/${game.id}`}
						aria-label={`View more details for ${game.title}`}
						data-sveltekit-prefetch
					>
						<Icon path={mdiChevronRight} />
					</a>
				</li>
			{/each}
		</ul>
	{/if}
</div>

<dialog bind:this={dialogElement}>
	<header>
		<p>Add new game</p>
		<button onclick={handleCloseModalClick}>Close</button>
	</header>
	<form {...addGame.preflight(addGameSchema).enhance(handleAddNewGameSubmit)}>
		<div>
			<label for="title">Game Title</label>
			<input required id="title" name="title" type="text" placeholder={newGameTitle} />
		</div>

		<fieldset>
			<legend>Number of players</legend>

			<div>
				<input id="4_players" name="players" value="4" type="radio" />
				<label for="4_players">4</label>

				<input id="6_players" name="players" value="6" type="radio" checked />
				<label for="6_players">6</label>

				<input id="8_players" name="players" value="8" type="radio" />
				<label for="8_players">8</label>
			</div>
		</fieldset>

		<button type="submit" disabled={isSubmitting ?? null}>Add new game</button>
	</form>
</dialog>
